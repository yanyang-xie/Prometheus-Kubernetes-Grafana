<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.11 (454874)"/><meta name="keywords" content="kubernetes, Prometheus"/><meta name="author" content="谢艳阳"/><meta name="created" content="2017-06-06 09:04:18 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2017-06-06 10:05:20 +0000"/><title>Prometheus自动抓取Kubernetes Serivce Metrics: 以JMX_Exporter为例</title></head><body><div>Kubernetes自动抓取Metrics: 以JMX_Exporter为例.</div><div><hr/></div><div>为VOD-simulator新建一个image, 启动时,注入<span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">jmx_prometheus_javaagent</span>代理开启端口号为<span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">1234</span>的metrics代理</div><div>Dockerfile:</div><table style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr><td style="width: 100%; border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; min-width: 100%;"><div>FROM yanyang/vod-simulator</div><div><br/></div><div>ADD ./jmx_prometheus_javaagent-0.9.jar /root</div><div>ADD ./sample-config.yml /root</div><div><br/></div><div>WORKDIR /root</div><div><br/></div><div>EXPOSE 8081</div><div><br/></div><div>WORKDIR /root/vod-simulator</div><div>ENTRYPOINT ["java", "-cp", "/root/vod-simulator/conf:/root/vod-simulator/conf-golden:/root/vod-simulator/lib/*", "-javaagent:/root/<span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">jmx_prometheus_javaagent</span>-0.9.jar=<span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">1234</span>:/root/sample-config.yml",   "com.thistech.vodsimulator.VODSimulatorServer"]</div></td></tr></tbody></table><div><br/></div><div># docker build -t yanyang/vod-simulator-agent .</div><div># docker push</div><div><br/></div><div><a href="Prometheus%E8%87%AA%E5%8A%A8%E6%8A%93%E5%8F%96Kubernetes%20Serivce%20Metrics%3A%20%E4%BB%A5JMX_Exporter%E4%B8%BA%E4%BE%8B.resources/Dockerfile">Dockerfile</a><a href="Prometheus%E8%87%AA%E5%8A%A8%E6%8A%93%E5%8F%96Kubernetes%20Serivce%20Metrics%3A%20%E4%BB%A5JMX_Exporter%E4%B8%BA%E4%BE%8B.resources/jmx_prometheus_javaagent-0.9.jar">jmx_prometheus_javaagent-0.9.jar</a><a href="Prometheus%E8%87%AA%E5%8A%A8%E6%8A%93%E5%8F%96Kubernetes%20Serivce%20Metrics%3A%20%E4%BB%A5JMX_Exporter%E4%B8%BA%E4%BE%8B.resources/sample-config.yml">sample-config.yml</a></div><div><br/></div><hr/><div>在Kubernetes中启动vod-simulator服务</div><div><a href="Prometheus%E8%87%AA%E5%8A%A8%E6%8A%93%E5%8F%96Kubernetes%20Serivce%20Metrics%3A%20%E4%BB%A5JMX_Exporter%E4%B8%BA%E4%BE%8B.resources/vod-simulator-rc-pod.yaml">vod-simulator-rc-pod.yaml</a> <a href="Prometheus%E8%87%AA%E5%8A%A8%E6%8A%93%E5%8F%96Kubernetes%20Serivce%20Metrics%3A%20%E4%BB%A5JMX_Exporter%E4%B8%BA%E4%BE%8B.resources/vod-simulator-svc.yaml">vod-simulator-svc.yaml</a><br/></div><div># kuberctl create -f vod-simualtor-rc-pod.yaml</div><div># kuberctl create -f vod-simualtor-svc.yaml<br/></div><div><br/></div><table style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr><td style="width: 100%; border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; min-width: 100%;"><div>vod-simualtor-rc-pod.yaml<br/></div><div>注意其需要开放两个端口号</div><div>- containerPort: 8081</div><div>- containerPort: 1234</div></td></tr></tbody></table><div><br/></div><table style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr><td style="width: 100%; border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; min-width: 100%;"><div>vod-simualtor-svc.yaml<br/></div><div><br/></div><div>注意: annotations是Kubernetes自动抓取时,需要过滤的标签.如果prometheus.io/scrape值为"true"则抓取其对应的端口为"prometheus.io/port"的/metrics.</div><div>annotations:</div><div>    prometheus.io/scrape: "true"</div><div>    prometheus.io/port: "1234"</div><div>    prometheus.io/probe: "true"</div><div><br/></div><div>其metrics端口'1234',也需要和业务端口'8081'一样暴露出来</div><div>ports:</div><div>    # The port that this service should serve on.</div><div>    - name: vod-8081</div><div>      port: 8081</div><div>      targetPort: 8081</div><div>      nodePort: 30881</div><div>    - name: metrics-1234</div><div>      port: 1234</div><div>      targetPort: 1234</div><div>      nodePort: 31234</div></td></tr></tbody></table><div><br/></div><hr/><div>Prometheus支持自动抓取带有特殊标记的service的metrics数据</div><div><a href="https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml#L25-L33">https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml#L25-L33</a></div><div><br/></div><div>需要在Prometheus的配置中, 增加pod scrape</div><table style="width: 100%; border-collapse: collapse; table-layout: fixed;"><tbody><tr><td style="width: 100%; border: 1px solid rgb(219, 219, 219); padding: 10px; margin: 0px; min-width: 100%;"><div>    - job_name: 'kubernetes-pods'</div><div>      kubernetes_sd_configs:</div><div>      - api_servers:</div><div>        - http://172.31.8.192:8080</div><div>        in_cluster: false</div><div>      relabel_configs:</div><div>      - source_labels: [__meta_kubernetes_pod_annotation_<span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"><b>prometheus_io_scrape</b></span>]</div><div>        action: keep</div><div>        <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">regex: true</span></div><div>      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</div><div>        action: replace</div><div>        target_label: __metrics_path__</div><div>        regex: (.+)</div><div>      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</div><div>        action: replace</div><div>        regex: (.+):(?:\d+);(\d+)</div><div>        replacement: ${1}:${2}</div><div>        target_label: __address__</div><div>      - action: labelmap</div><div>        regex: __meta_kubernetes_pod_label_(.+)</div><div>      - source_labels: [__meta_kubernetes_pod_namespace]</div><div>        action: replace</div><div>        target_label: kubernetes_namespace</div><div>      - source_labels: [__meta_kubernetes_pod_name]</div><div>        action: replace</div><div>        target_label: kubernetes_pod_name</div></td></tr></tbody></table><div><br/></div><div>注意这里的<span style="background-color: rgb(255, 250, 165); font-weight: bold;-evernote-highlight:true;">prometheus_io_scrape, 对应的就是Kubernetes service中定义的</span><span style="background-color: rgb(255, 250, 165); font-weight: bold;-evernote-highlight:true;">annotations</span></div><div><span style="">annotations:</span></div><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;"/>    prometheus.io/scrape: "true"</div><div><br/></div><div>这个是典型的配置</div><div><a href="Prometheus%E8%87%AA%E5%8A%A8%E6%8A%93%E5%8F%96Kubernetes%20Serivce%20Metrics%3A%20%E4%BB%A5JMX_Exporter%E4%B8%BA%E4%BE%8B.resources/prometheus-configmap-2.yaml">prometheus-configmap-2.yaml</a></div><div><hr/></div><div><br/></div><div>Service启动成功后, vod-simualtor sevice的</div><div><ul><li>Annotations显示Prometheus.io/scrape:true, 抓取端口是1234<br/></li><li>监控的端口是8081/30881, 1234/31234</li></ul></div><div><img src="Prometheus%E8%87%AA%E5%8A%A8%E6%8A%93%E5%8F%96Kubernetes%20Serivce%20Metrics%3A%20%E4%BB%A5JMX_Exporter%E4%B8%BA%E4%BE%8B.resources/Screen%20Shot%202017-06-06%20at%2017.58.22.png" height="1172" width="2700"/><br/></div><div><br/></div><div>查看Prometheus Dashboard, 可以看到Status-&gt;Endpoint中增加了vod-simulator, 其中的地址是http://****:1234/metrics,状态是UP</div><div><img src="Prometheus%E8%87%AA%E5%8A%A8%E6%8A%93%E5%8F%96Kubernetes%20Serivce%20Metrics%3A%20%E4%BB%A5JMX_Exporter%E4%B8%BA%E4%BE%8B.resources/Screen%20Shot%202017-06-06%20at%2017.58.47.png" height="1498" width="2696"/><br/></div><div><br/></div><div>查看Graph, 可以看到jvm的信息已经存在了</div><div><img src="Prometheus%E8%87%AA%E5%8A%A8%E6%8A%93%E5%8F%96Kubernetes%20Serivce%20Metrics%3A%20%E4%BB%A5JMX_Exporter%E4%B8%BA%E4%BE%8B.resources/Screen%20Shot%202017-06-06%20at%2018.03.53.png" height="970" width="2646"/><br/></div><div><br/></div><div><img src="Prometheus%E8%87%AA%E5%8A%A8%E6%8A%93%E5%8F%96Kubernetes%20Serivce%20Metrics%3A%20%E4%BB%A5JMX_Exporter%E4%B8%BA%E4%BE%8B.resources/Screen%20Shot%202017-06-06%20at%2018.05.04.png" height="556" width="2714"/><br/></div><div><br/></div></body></html>